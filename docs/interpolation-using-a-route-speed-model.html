<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>10 Interpolation Using A Route Speed Model | Visualising WRC Telemetry Data With R</title>
  <meta name="description" content="Analysing WRC telemetry data." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="10 Interpolation Using A Route Speed Model | Visualising WRC Telemetry Data With R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Analysing WRC telemetry data." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="10 Interpolation Using A Route Speed Model | Visualising WRC Telemetry Data With R" />
  
  <meta name="twitter:description" content="Analysing WRC telemetry data." />
  

<meta name="author" content="Tony Hirst" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="estimating-time-deltas-between-drivers-over-small-sections.html"/>
<link rel="next" href="full-telemetry.html"/>
<script src="libs/header-attrs-2.11.22/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.1.0/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.1.0/leaflet-providers-plugin.js"></script>
<script data-goatcounter="https://rallydatajunkie.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><strong>Visualing WRC Telemetry</strong></a></li>

<li class="divider"></li>
<li><a href="index.html#preface">Preface<span></span></a></li>
<li class="chapter" data-level="1" data-path="introducing-wrc-telemetry.html"><a href="introducing-wrc-telemetry.html"><i class="fa fa-check"></i><b>1</b> Introducing WRC Telemetry<span></span></a></li>
<li class="chapter" data-level="2" data-path="loading-the-live-telemetry-route-data.html"><a href="loading-the-live-telemetry-route-data.html"><i class="fa fa-check"></i><b>2</b> Loading the Live Telemetry Route Data<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="loading-the-live-telemetry-route-data.html"><a href="loading-the-live-telemetry-route-data.html#spatial-utilities"><i class="fa fa-check"></i><b>2.1</b> Spatial Utilities<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="loading-the-live-telemetry-route-data.html"><a href="loading-the-live-telemetry-route-data.html#loading-in-the-telemetry-route-data"><i class="fa fa-check"></i><b>2.2</b> Loading in the Telemetry Route Data<span></span></a></li>
<li class="chapter" data-level="2.3" data-path="loading-the-live-telemetry-route-data.html"><a href="loading-the-live-telemetry-route-data.html#preparing-the-telemetry-route-data"><i class="fa fa-check"></i><b>2.3</b> Preparing the Telemetry Route Data<span></span></a></li>
<li class="chapter" data-level="2.4" data-path="loading-the-live-telemetry-route-data.html"><a href="loading-the-live-telemetry-route-data.html#visual-preview-of-the-telemetry-route-data"><i class="fa fa-check"></i><b>2.4</b> Visual Preview of the Telemetry Route Data<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="using-official-route-data.html"><a href="using-official-route-data.html"><i class="fa fa-check"></i><b>3</b> Using Official Route Data<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="using-official-route-data.html"><a href="using-official-route-data.html#loading-official-stage-route-data"><i class="fa fa-check"></i><b>3.1</b> Loading Official Stage Route Data<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="using-official-route-data.html"><a href="using-official-route-data.html#comparing-stage-route-telemetry-and-the-stage-route"><i class="fa fa-check"></i><b>3.2</b> Comparing Stage Route Telemetry and the Stage Route<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="telemetry-data-along-a-stage.html"><a href="telemetry-data-along-a-stage.html"><i class="fa fa-check"></i><b>4</b> Telemetry Data Along a Stage<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="telemetry-data-along-a-stage.html"><a href="telemetry-data-along-a-stage.html#finding-points-on-the-route-closest-to-the-telemetry-data-locations"><i class="fa fa-check"></i><b>4.1</b> Finding Points on the Route Closest to the Telemetry Data Locations<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plotting-locations-a-certain-time-into-the-stage.html"><a href="plotting-locations-a-certain-time-into-the-stage.html"><i class="fa fa-check"></i><b>5</b> Plotting Locations a Certain Time Into the Stage<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="plotting-locations-a-certain-time-into-the-stage.html"><a href="plotting-locations-a-certain-time-into-the-stage.html#find-the-stage-telemetry-time-series-origin"><i class="fa fa-check"></i><b>5.1</b> Find the Stage Telemetry Time Series Origin<span></span></a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="plotting-locations-a-certain-time-into-the-stage.html"><a href="plotting-locations-a-certain-time-into-the-stage.html#estimating-the-start-time"><i class="fa fa-check"></i><b>5.1.1</b> Estimating the Start Time<span></span></a></li>
<li class="chapter" data-level="5.1.2" data-path="plotting-locations-a-certain-time-into-the-stage.html"><a href="plotting-locations-a-certain-time-into-the-stage.html#using-a-false-origin"><i class="fa fa-check"></i><b>5.1.2</b> Using a False Origin<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="plotting-locations-a-certain-time-into-the-stage.html"><a href="plotting-locations-a-certain-time-into-the-stage.html#plotting-the-stage-telemetry-time-series"><i class="fa fa-check"></i><b>5.2</b> Plotting the Stage Telemetry Time Series<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="interpolating-times-along-the-route.html"><a href="interpolating-times-along-the-route.html"><i class="fa fa-check"></i><b>6</b> Interpolating Times Along the Route<span></span></a></li>
<li class="chapter" data-level="7" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html"><i class="fa fa-check"></i><b>7</b> Comparing Drivers’ Live (Sparse) Telemetry<span></span></a>
<ul>
<li class="chapter" data-level="7.1" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#load-route-data"><i class="fa fa-check"></i><b>7.1</b> Load Route Data<span></span></a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#generate-buffered-route"><i class="fa fa-check"></i><b>7.1.1</b> Generate Buffered Route<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#load-driver-data"><i class="fa fa-check"></i><b>7.2</b> Load Driver Data<span></span></a></li>
<li class="chapter" data-level="7.3" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#get-annotated-route-telemetry"><i class="fa fa-check"></i><b>7.3</b> Get Annotated Route Telemetry<span></span></a></li>
<li class="chapter" data-level="7.4" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#create-driver-estimators"><i class="fa fa-check"></i><b>7.4</b> Create Driver Estimators<span></span></a></li>
<li class="chapter" data-level="7.5" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#creating-a-common-false-time-origin"><i class="fa fa-check"></i><b>7.5</b> Creating a Common False Time Origin<span></span></a></li>
<li class="chapter" data-level="7.6" data-path="comparing-drivers-live-sparse-telemetry.html"><a href="comparing-drivers-live-sparse-telemetry.html#visual-driver-comparison"><i class="fa fa-check"></i><b>7.6</b> Visual Driver Comparison<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="finding-the-time-to-complete-a-particular-stretch.html"><a href="finding-the-time-to-complete-a-particular-stretch.html"><i class="fa fa-check"></i><b>8</b> Finding the Time to Complete a Particular Stretch<span></span></a></li>
<li class="chapter" data-level="9" data-path="estimating-time-deltas-between-drivers-over-small-sections.html"><a href="estimating-time-deltas-between-drivers-over-small-sections.html"><i class="fa fa-check"></i><b>9</b> Estimating Time Deltas Between Drivers Over Small Sections<span></span></a></li>
<li class="chapter" data-level="10" data-path="interpolation-using-a-route-speed-model.html"><a href="interpolation-using-a-route-speed-model.html"><i class="fa fa-check"></i><b>10</b> Interpolation Using A Route Speed Model<span></span></a>
<ul>
<li class="chapter" data-level="10.1" data-path="interpolation-using-a-route-speed-model.html"><a href="interpolation-using-a-route-speed-model.html#creating-a-route-speed-model"><i class="fa fa-check"></i><b>10.1</b> Creating a Route Speed Model<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="full-telemetry.html"><a href="full-telemetry.html"><i class="fa fa-check"></i><b>11</b> Full telemetry<span></span></a></li>
<li class="chapter" data-level="12" data-path="generating-a-trajr-route-from-the-telemetry-data.html"><a href="generating-a-trajr-route-from-the-telemetry-data.html"><i class="fa fa-check"></i><b>12</b> Generating a <code>trajr</code> Route From the Telemetry Data<span></span></a></li>
<li class="chapter" data-level="13" data-path="finding-distance-into-a-common-route.html"><a href="finding-distance-into-a-common-route.html"><i class="fa fa-check"></i><b>13</b> Finding Distance into a Common Route<span></span></a></li>
<li class="chapter" data-level="14" data-path="looking-at-braking-behaviour.html"><a href="looking-at-braking-behaviour.html"><i class="fa fa-check"></i><b>14</b> Looking At Braking Behaviour<span></span></a>
<ul>
<li class="chapter" data-level="14.1" data-path="looking-at-braking-behaviour.html"><a href="looking-at-braking-behaviour.html#throttle-comparison"><i class="fa fa-check"></i><b>14.1</b> Throttle Comparison<span></span></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="comparing-times-into-stage.html"><a href="comparing-times-into-stage.html"><i class="fa fa-check"></i><b>15</b> Comparing Times Into Stage<span></span></a></li>
<li class="chapter" data-level="16" data-path="correlating-telemetry-traces.html"><a href="correlating-telemetry-traces.html"><i class="fa fa-check"></i><b>16</b> Correlating Telemetry Traces<span></span></a></li>
<li class="chapter" data-level="17" data-path="smoothing-a-route.html"><a href="smoothing-a-route.html"><i class="fa fa-check"></i><b>17</b> Smoothing a Route<span></span></a></li>
<li class="chapter" data-level="18" data-path="validating-the-speed-model.html"><a href="validating-the-speed-model.html"><i class="fa fa-check"></i><b>18</b> Validating the Speed Model<span></span></a></li>
<li class="chapter" data-level="19" data-path="numbering-corners.html"><a href="numbering-corners.html"><i class="fa fa-check"></i><b>19</b> Numbering Corners<span></span></a></li>
<li class="divider"></li>
<li><a href="https://rallydatajunkie.com/"><em>RallyDataJunkie.com</em></a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Visualising WRC Telemetry Data With R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="interpolation-using-a-route-speed-model" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">10</span> Interpolation Using A Route Speed Model<a href="interpolation-using-a-route-speed-model.html#interpolation-using-a-route-speed-model" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Based on the curvature of the route, the speed model gives us a crude estimate of how long it takes to get between two points. If the route is a flat straight between the points, we’ll travel 1km in much less time than if the route it tight and twisty.</p>
<p>The simple <code>approxfun()</code> interpolator uses a linear model to interpolate times between actual time points, but we might be able to improve interpolated estimates using a non-linear model based on a speed model generated over the route based on the route curvature.</p>
<ul>
<li>identify distance into stage required (<code>desired_d</code>)</li>
<li>find distance into stage for each</li>
<li>get consecutive telemetry points between which desired distance lays (<code>in_d</code>, <code>out_d</code>, <code>in_t</code>, <code>out_t</code>)</li>
</ul>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="interpolation-using-a-route-speed-model.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> l <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">1.1</span>,<span class="fl">2.1</span>,<span class="fl">3.1</span>,<span class="fl">4.1</span>,<span class="fl">5.1</span>)</span>
<span id="cb72-2"><a href="interpolation-using-a-route-speed-model.html#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">c</span>(l[<span class="fu">findInterval</span>(<span class="dv">3</span>, l)], l[<span class="fu">findInterval</span>(<span class="dv">3</span>, l)<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb72-3"><a href="interpolation-using-a-route-speed-model.html#cb72-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">2.1</span> <span class="fl">3.1</span></span>
<span id="cb72-4"><a href="interpolation-using-a-route-speed-model.html#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">c</span>(l[<span class="fu">findInterval</span>(<span class="dv">1</span>, l)], l[<span class="fu">findInterval</span>(<span class="dv">1</span>, l)<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb72-5"><a href="interpolation-using-a-route-speed-model.html#cb72-5" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.1</span></span>
<span id="cb72-6"><a href="interpolation-using-a-route-speed-model.html#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">c</span>(l[<span class="fu">findInterval</span>(<span class="dv">11</span>, l)], l[<span class="fu">findInterval</span>(<span class="dv">11</span>, l)<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb72-7"><a href="interpolation-using-a-route-speed-model.html#cb72-7" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">5.1</span>  <span class="cn">NA</span></span></code></pre></div>
<ul>
<li>get speed model</li>
<li>get model time at points (in_mt=model(in_d), out_mt=model(out_d), desired_mt=model(desired_d))</li>
<li>get interpolated normalised model time between points, desired_nt = (desired_mt - in_mt)/(out_mt - in_mt)</li>
<li>get predicted time desired_t = desired_nt*(out_t - in_t) + in_t</li>
</ul>
<div id="creating-a-route-speed-model" class="section level2 hasAnchor" number="10.1">
<h2><span class="header-section-number">10.1</span> Creating a Route Speed Model<a href="interpolation-using-a-route-speed-model.html#creating-a-route-speed-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the <em>To See The Invisible</em> rally pacenotes tutorial series by David Nafría, corners are given a particular severity based on curvature. Simple models of expected speeds for corners of a particular severity are also described for different classes of rally car.</p>
<p>We can use this approach to create a simple speed model based on curvature of the rally route. Using the expected cornering speed as a target speed and a simple acceleration model, as well as theoretical maximum speed, we can accelerate the car into and out of each corner based and generate a speed model as a result.</p>
<p><em>For more on analysing and visualising rally stage routes, see <a href="https://rallydatajunkie.com/visualising-rally-stages/"><strong>Visualising WRC Rally Stages With rayshader and R</strong></a>.</em></p>
<p>The <code>rLFT</code> processing linear features <em>R</em> package provides a handy tool for modeling curvature along each point of a route in the form of a <em>boundary convexity tool</em> (<code>bct()</code>). The curvature of a moving segment along the route is determined, along with the center of curvature and a convexity measure.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="interpolation-using-a-route-speed-model.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rLFT)</span>
<span id="cb73-2"><a href="interpolation-using-a-route-speed-model.html#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="interpolation-using-a-route-speed-model.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The step dist is how far we move the window at each step</span></span>
<span id="cb73-4"><a href="interpolation-using-a-route-speed-model.html#cb73-4" aria-hidden="true" tabindex="-1"></a>stepdist <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb73-5"><a href="interpolation-using-a-route-speed-model.html#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The window is the length of the route for which we find the curvature</span></span>
<span id="cb73-6"><a href="interpolation-using-a-route-speed-model.html#cb73-6" aria-hidden="true" tabindex="-1"></a>window <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb73-7"><a href="interpolation-using-a-route-speed-model.html#cb73-7" aria-hidden="true" tabindex="-1"></a>get_route_convexity <span class="ot">=</span> <span class="cf">function</span>(route_basis_utm, <span class="at">stepdist=</span><span class="dv">10</span>, <span class="at">window=</span><span class="dv">20</span>){</span>
<span id="cb73-8"><a href="interpolation-using-a-route-speed-model.html#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bct</span>(route_basis_utm,</span>
<span id="cb73-9"><a href="interpolation-using-a-route-speed-model.html#cb73-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># distance between measurements </span></span>
<span id="cb73-10"><a href="interpolation-using-a-route-speed-model.html#cb73-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">step =</span> stepdist,</span>
<span id="cb73-11"><a href="interpolation-using-a-route-speed-model.html#cb73-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">window =</span> window, <span class="at">ridName =</span> <span class="st">&quot;name&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-12"><a href="interpolation-using-a-route-speed-model.html#cb73-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dist =</span>  (<span class="fu">lead</span>(MidMeas)<span class="sc">-</span>MidMeas),</span>
<span id="cb73-13"><a href="interpolation-using-a-route-speed-model.html#cb73-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">cum_dist =</span> <span class="fu">cumsum</span>(dist))</span>
<span id="cb73-14"><a href="interpolation-using-a-route-speed-model.html#cb73-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-15"><a href="interpolation-using-a-route-speed-model.html#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="interpolation-using-a-route-speed-model.html#cb73-16" aria-hidden="true" tabindex="-1"></a>route_convexity <span class="ot">=</span> <span class="fu">get_route_convexity</span>(stage_route_utm)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.180   0.033   0.214 
## [1] &quot;Features skipped due to size: &quot;
## logical(0)</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="interpolation-using-a-route-speed-model.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(route_convexity, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   FID                   RID MidMeas WindowSize RawConvexity ConvexityIndex
## 1   1 SS7/11 KakaristoHassi      10         20        0.000          0.000
## 2   1 SS7/11 KakaristoHassi      20         20        0.000          0.000
## 3   1 SS7/11 KakaristoHassi      30         20        0.788          0.079
##   Sinuosity Midpoint_X Midpoint_Y dist cum_dist
## 1     0.500   400689.0    6857086   10       10
## 2     0.500   400698.6    6857084   10       20
## 3     0.503   400708.3    6857081   10       30</code></pre>
<p>Although the boundary convexity tool gives us a convexity measure, we can also create our own curvature metric that corresponds more closely to Nafría’s model. I don’t know how to write vectorised functions properly, so I’ll create a simple function that generates the curvature at a particular point on a route, and then use the <code>Vectorize()</code> helper function to as-if vectorise it for me.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="interpolation-using-a-route-speed-model.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb77-2"><a href="interpolation-using-a-route-speed-model.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The curvature function takes an arc defined over</span></span>
<span id="cb77-3"><a href="interpolation-using-a-route-speed-model.html#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># x and y coordinate lists</span></span>
<span id="cb77-4"><a href="interpolation-using-a-route-speed-model.html#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="interpolation-using-a-route-speed-model.html#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co">#circlefit, from pracma::</span></span>
<span id="cb77-6"><a href="interpolation-using-a-route-speed-model.html#cb77-6" aria-hidden="true" tabindex="-1"></a>circlefit <span class="ot">=</span> <span class="cf">function</span> (xp, yp, <span class="at">fast =</span> <span class="cn">TRUE</span>) </span>
<span id="cb77-7"><a href="interpolation-using-a-route-speed-model.html#cb77-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb77-8"><a href="interpolation-using-a-route-speed-model.html#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.vector</span>(xp, <span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.vector</span>(yp, <span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>)) </span>
<span id="cb77-9"><a href="interpolation-using-a-route-speed-model.html#cb77-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Arguments &#39;xp&#39; and &#39;yp&#39; must be numeric vectors.&quot;</span>)</span>
<span id="cb77-10"><a href="interpolation-using-a-route-speed-model.html#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(xp) <span class="sc">!=</span> <span class="fu">length</span>(yp)) </span>
<span id="cb77-11"><a href="interpolation-using-a-route-speed-model.html#cb77-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Vectors &#39;xp&#39; and &#39;yp&#39; must be of the same length.&quot;</span>)</span>
<span id="cb77-12"><a href="interpolation-using-a-route-speed-model.html#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>fast) </span>
<span id="cb77-13"><a href="interpolation-using-a-route-speed-model.html#cb77-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Option &#39;fast&#39; is deprecated and will not be used!&quot;</span>, </span>
<span id="cb77-14"><a href="interpolation-using-a-route-speed-model.html#cb77-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">call. =</span> <span class="cn">FALSE</span>, <span class="at">immediate. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb77-15"><a href="interpolation-using-a-route-speed-model.html#cb77-15" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">length</span>(xp)</span>
<span id="cb77-16"><a href="interpolation-using-a-route-speed-model.html#cb77-16" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">qr.solve</span>(<span class="fu">cbind</span>(xp, yp, <span class="dv">1</span>), <span class="fu">matrix</span>(xp<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> yp<span class="sc">^</span><span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">1</span>))</span>
<span id="cb77-17"><a href="interpolation-using-a-route-speed-model.html#cb77-17" aria-hidden="true" tabindex="-1"></a>    v <span class="ot">&lt;-</span> <span class="fu">c</span>(p[<span class="dv">1</span>]<span class="sc">/</span><span class="dv">2</span>, p[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span>, <span class="fu">sqrt</span>((p[<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> p[<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">4</span> <span class="sc">+</span> p[<span class="dv">3</span>]))</span>
<span id="cb77-18"><a href="interpolation-using-a-route-speed-model.html#cb77-18" aria-hidden="true" tabindex="-1"></a>    rms <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>((<span class="fu">sqrt</span>((xp <span class="sc">-</span> v[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (yp <span class="sc">-</span> v[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> v[<span class="dv">3</span>])<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>n)</span>
<span id="cb77-19"><a href="interpolation-using-a-route-speed-model.html#cb77-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#cat(&quot;RMS error:&quot;, rms, &quot;\n&quot;)</span></span>
<span id="cb77-20"><a href="interpolation-using-a-route-speed-model.html#cb77-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(v)</span>
<span id="cb77-21"><a href="interpolation-using-a-route-speed-model.html#cb77-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-22"><a href="interpolation-using-a-route-speed-model.html#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="interpolation-using-a-route-speed-model.html#cb77-23" aria-hidden="true" tabindex="-1"></a>curvature <span class="ot">=</span> <span class="cf">function</span>(x,y){</span>
<span id="cb77-24"><a href="interpolation-using-a-route-speed-model.html#cb77-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#729181.8, 729186.1, 729190.4</span></span>
<span id="cb77-25"><a href="interpolation-using-a-route-speed-model.html#cb77-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#4957667 , 4957676, 4957685</span></span>
<span id="cb77-26"><a href="interpolation-using-a-route-speed-model.html#cb77-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb77-27"><a href="interpolation-using-a-route-speed-model.html#cb77-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># circlefit gives an error if we pass a straight line</span></span>
<span id="cb77-28"><a href="interpolation-using-a-route-speed-model.html#cb77-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Also hide the print statement in circlefit</span></span>
<span id="cb77-29"><a href="interpolation-using-a-route-speed-model.html#cb77-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># circlefit() returns the x and y coords of the circle center</span></span>
<span id="cb77-30"><a href="interpolation-using-a-route-speed-model.html#cb77-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># as well as the radius of curvature</span></span>
<span id="cb77-31"><a href="interpolation-using-a-route-speed-model.html#cb77-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># We could then also calculate the angle and arc length</span></span>
<span id="cb77-32"><a href="interpolation-using-a-route-speed-model.html#cb77-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">circlefit</span>(x,y)[<span class="dv">3</span>]</span>
<span id="cb77-33"><a href="interpolation-using-a-route-speed-model.html#cb77-33" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb77-34"><a href="interpolation-using-a-route-speed-model.html#cb77-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(err) { </span>
<span id="cb77-35"><a href="interpolation-using-a-route-speed-model.html#cb77-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For a straight, return the first co-ord and Inf diameter</span></span>
<span id="cb77-36"><a href="interpolation-using-a-route-speed-model.html#cb77-36" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Alternatively, pass zero diameter?</span></span>
<span id="cb77-37"><a href="interpolation-using-a-route-speed-model.html#cb77-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>], <span class="cn">Inf</span>)[<span class="dv">3</span>]})</span>
<span id="cb77-38"><a href="interpolation-using-a-route-speed-model.html#cb77-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-39"><a href="interpolation-using-a-route-speed-model.html#cb77-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-40"><a href="interpolation-using-a-route-speed-model.html#cb77-40" aria-hidden="true" tabindex="-1"></a>curvature2 <span class="ot">=</span> <span class="cf">function</span>(x1, x2, x3, y1, y2, y3){</span>
<span id="cb77-41"><a href="interpolation-using-a-route-speed-model.html#cb77-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">curvature</span>(<span class="fu">c</span>(x1, x2, x3), <span class="fu">c</span>(y1, y2, y3))</span>
<span id="cb77-42"><a href="interpolation-using-a-route-speed-model.html#cb77-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-43"><a href="interpolation-using-a-route-speed-model.html#cb77-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-44"><a href="interpolation-using-a-route-speed-model.html#cb77-44" aria-hidden="true" tabindex="-1"></a><span class="co"># The base::Vectorize function provides a lazy way of </span></span>
<span id="cb77-45"><a href="interpolation-using-a-route-speed-model.html#cb77-45" aria-hidden="true" tabindex="-1"></a><span class="co"># vectorising a non-vectorised function</span></span>
<span id="cb77-46"><a href="interpolation-using-a-route-speed-model.html#cb77-46" aria-hidden="true" tabindex="-1"></a>curvatures_ <span class="ot">=</span> <span class="fu">Vectorize</span>(curvature2)</span>
<span id="cb77-47"><a href="interpolation-using-a-route-speed-model.html#cb77-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-48"><a href="interpolation-using-a-route-speed-model.html#cb77-48" aria-hidden="true" tabindex="-1"></a>curvatures <span class="ot">=</span> <span class="cf">function</span>(route_convexity){</span>
<span id="cb77-49"><a href="interpolation-using-a-route-speed-model.html#cb77-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">curvatures_</span>(<span class="fu">lag</span>(route_convexity<span class="sc">$</span>Midpoint_X),</span>
<span id="cb77-50"><a href="interpolation-using-a-route-speed-model.html#cb77-50" aria-hidden="true" tabindex="-1"></a>              route_convexity<span class="sc">$</span>Midpoint_X,</span>
<span id="cb77-51"><a href="interpolation-using-a-route-speed-model.html#cb77-51" aria-hidden="true" tabindex="-1"></a>              <span class="fu">lead</span>(route_convexity<span class="sc">$</span>Midpoint_X),</span>
<span id="cb77-52"><a href="interpolation-using-a-route-speed-model.html#cb77-52" aria-hidden="true" tabindex="-1"></a>              <span class="fu">lag</span>(route_convexity<span class="sc">$</span>Midpoint_Y),</span>
<span id="cb77-53"><a href="interpolation-using-a-route-speed-model.html#cb77-53" aria-hidden="true" tabindex="-1"></a>              route_convexity<span class="sc">$</span>Midpoint_Y,</span>
<span id="cb77-54"><a href="interpolation-using-a-route-speed-model.html#cb77-54" aria-hidden="true" tabindex="-1"></a>              <span class="fu">lead</span>(route_convexity<span class="sc">$</span>Midpoint_Y))</span>
<span id="cb77-55"><a href="interpolation-using-a-route-speed-model.html#cb77-55" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This model uses the corner centre measures calculated by the boundary convexity tool to return a radius for the curvature of each segment:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="interpolation-using-a-route-speed-model.html#cb78-1" aria-hidden="true" tabindex="-1"></a>route_convexity<span class="sc">$</span>radius <span class="ot">=</span> <span class="fu">curvatures</span>(route_convexity)</span></code></pre></div>
<p>We can now generate the cornering speed model. The corner speed model generates several things:</p>
<ul>
<li>a corner index, <code>invisble_ci</code>, which is an integer representing the corner radius;</li>
<li>a notional segment/corner target speed, <code>invisible_sp</code>.</li>
</ul>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="interpolation-using-a-route-speed-model.html#cb79-1" aria-hidden="true" tabindex="-1"></a>corner_speed_model <span class="ot">=</span> <span class="cf">function</span>(route_convexity,</span>
<span id="cb79-2"><a href="interpolation-using-a-route-speed-model.html#cb79-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">invisible_speeds =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">85</span>,</span>
<span id="cb79-3"><a href="interpolation-using-a-route-speed-model.html#cb79-3" aria-hidden="true" tabindex="-1"></a>                                                    <span class="dv">100</span>, <span class="dv">115</span>, <span class="dv">120</span>, <span class="dv">130</span>, <span class="dv">170</span>),</span>
<span id="cb79-4"><a href="interpolation-using-a-route-speed-model.html#cb79-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">speed_modifier =</span> <span class="dv">0</span>){</span>
<span id="cb79-5"><a href="interpolation-using-a-route-speed-model.html#cb79-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-6"><a href="interpolation-using-a-route-speed-model.html#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Provide a simple means of increasing the cornering speeds</span></span>
<span id="cb79-7"><a href="interpolation-using-a-route-speed-model.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  invisible_speeds <span class="ot">=</span> invisible_speeds <span class="sc">+</span> speed_modifier</span>
<span id="cb79-8"><a href="interpolation-using-a-route-speed-model.html#cb79-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-9"><a href="interpolation-using-a-route-speed-model.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  invisible_bins <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="fl">27.5</span>, <span class="dv">35</span>,</span>
<span id="cb79-10"><a href="interpolation-using-a-route-speed-model.html#cb79-10" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">45</span>, <span class="dv">60</span>, <span class="fl">77.5</span>, <span class="dv">100</span>, <span class="dv">175</span>, <span class="cn">Inf</span>)</span>
<span id="cb79-11"><a href="interpolation-using-a-route-speed-model.html#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="interpolation-using-a-route-speed-model.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>invisible_ci <span class="ot">=</span> <span class="fu">cut</span>(route_convexity<span class="sc">$</span>radius,</span>
<span id="cb79-13"><a href="interpolation-using-a-route-speed-model.html#cb79-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">breaks =</span> invisible_bins,</span>
<span id="cb79-14"><a href="interpolation-using-a-route-speed-model.html#cb79-14" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">labels =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(invisible_bins)<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb79-15"><a href="interpolation-using-a-route-speed-model.html#cb79-15" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">ordered_result=</span><span class="cn">TRUE</span>)</span>
<span id="cb79-16"><a href="interpolation-using-a-route-speed-model.html#cb79-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-17"><a href="interpolation-using-a-route-speed-model.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Speeds in km/h</span></span>
<span id="cb79-18"><a href="interpolation-using-a-route-speed-model.html#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#invisible_speeds = c(10, 40, 50, 60, 70, 80,</span></span>
<span id="cb79-19"><a href="interpolation-using-a-route-speed-model.html#cb79-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                     95, 110, 120, 130, 180)</span></span>
<span id="cb79-20"><a href="interpolation-using-a-route-speed-model.html#cb79-20" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb79-21"><a href="interpolation-using-a-route-speed-model.html#cb79-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-22"><a href="interpolation-using-a-route-speed-model.html#cb79-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-23"><a href="interpolation-using-a-route-speed-model.html#cb79-23" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>invisible_sp <span class="ot">=</span> <span class="fu">cut</span>(route_convexity<span class="sc">$</span>radius,</span>
<span id="cb79-24"><a href="interpolation-using-a-route-speed-model.html#cb79-24" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">breaks =</span> invisible_bins,</span>
<span id="cb79-25"><a href="interpolation-using-a-route-speed-model.html#cb79-25" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">labels =</span> invisible_speeds,</span>
<span id="cb79-26"><a href="interpolation-using-a-route-speed-model.html#cb79-26" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">ordered_result=</span><span class="cn">TRUE</span>)</span>
<span id="cb79-27"><a href="interpolation-using-a-route-speed-model.html#cb79-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-28"><a href="interpolation-using-a-route-speed-model.html#cb79-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cast speed as factor, via character, to integer</span></span>
<span id="cb79-29"><a href="interpolation-using-a-route-speed-model.html#cb79-29" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>invisible_sp <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(route_convexity<span class="sc">$</span>invisible_sp))</span>
<span id="cb79-30"><a href="interpolation-using-a-route-speed-model.html#cb79-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-31"><a href="interpolation-using-a-route-speed-model.html#cb79-31" aria-hidden="true" tabindex="-1"></a>  route_convexity</span>
<span id="cb79-32"><a href="interpolation-using-a-route-speed-model.html#cb79-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Applying the speed model to our route gives us a corner index and notional target speed for each segment:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="interpolation-using-a-route-speed-model.html#cb80-1" aria-hidden="true" tabindex="-1"></a>route_convexity <span class="ot">=</span> route_convexity <span class="sc">%&gt;%</span> <span class="fu">corner_speed_model</span>()</span>
<span id="cb80-2"><a href="interpolation-using-a-route-speed-model.html#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="interpolation-using-a-route-speed-model.html#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(route_convexity, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   FID                   RID MidMeas WindowSize RawConvexity ConvexityIndex
## 1   1 SS7/11 KakaristoHassi      10         20        0.000          0.000
## 2   1 SS7/11 KakaristoHassi      20         20        0.000          0.000
## 3   1 SS7/11 KakaristoHassi      30         20        0.788          0.079
##   Sinuosity Midpoint_X Midpoint_Y dist cum_dist radius invisible_ci
## 1     0.500   400689.0    6857086   10       10    Inf           11
## 2     0.500   400698.6    6857084   10       20    Inf           11
## 3     0.503   400708.3    6857081   10       30    Inf           11
##   invisible_sp
## 1          170
## 2          170
## 3          170</code></pre>
<p>We can build up the speed model for the route. At each step we accelerate towards the nominal sector target speed (the <code>invisible_sp</code> value). We can’t accelerate infinitely fast, so our actual target accumulated speed for the segment, <code>acc_sp</code>, is a simple function of the current speed and the notional target speed. We can then calculate the notional time to complete that segment, <code>invisible_time</code>.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="interpolation-using-a-route-speed-model.html#cb82-1" aria-hidden="true" tabindex="-1"></a>acceleration_model <span class="ot">=</span> <span class="cf">function</span>(route_convexity, <span class="at">stepdist=</span><span class="dv">10</span>,</span>
<span id="cb82-2"><a href="interpolation-using-a-route-speed-model.html#cb82-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">acc =</span> <span class="fl">0.1</span>, <span class="at">dec =</span> <span class="fl">0.1</span>) {</span>
<span id="cb82-3"><a href="interpolation-using-a-route-speed-model.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Acceleration model</span></span>
<span id="cb82-4"><a href="interpolation-using-a-route-speed-model.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  sp <span class="ot">=</span> route_convexity<span class="sc">$</span>invisible_sp</span>
<span id="cb82-5"><a href="interpolation-using-a-route-speed-model.html#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nominal starting target speed</span></span>
<span id="cb82-6"><a href="interpolation-using-a-route-speed-model.html#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In we don&#39;t set this, we don&#39;t get started moving</span></span>
<span id="cb82-7"><a href="interpolation-using-a-route-speed-model.html#cb82-7" aria-hidden="true" tabindex="-1"></a>  sp[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">30</span> </span>
<span id="cb82-8"><a href="interpolation-using-a-route-speed-model.html#cb82-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-9"><a href="interpolation-using-a-route-speed-model.html#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use crude acceleration / brake weights</span></span>
<span id="cb82-10"><a href="interpolation-using-a-route-speed-model.html#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(sp)<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb82-11"><a href="interpolation-using-a-route-speed-model.html#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple linear model - accumulated speed is based on</span></span>
<span id="cb82-12"><a href="interpolation-using-a-route-speed-model.html#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the current speed and the notional segment speed</span></span>
<span id="cb82-13"><a href="interpolation-using-a-route-speed-model.html#cb82-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accelerate up</span></span>
<span id="cb82-14"><a href="interpolation-using-a-route-speed-model.html#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sp[i<span class="dv">-1</span>]<span class="sc">&lt;=</span>sp[i]) sp[i] <span class="ot">=</span> (sp[i<span class="dv">-1</span>] <span class="sc">+</span> acc <span class="sc">*</span> sp[i]) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>acc)</span>
<span id="cb82-15"><a href="interpolation-using-a-route-speed-model.html#cb82-15" aria-hidden="true" tabindex="-1"></a>                                    </span>
<span id="cb82-16"><a href="interpolation-using-a-route-speed-model.html#cb82-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decelerate down</span></span>
<span id="cb82-17"><a href="interpolation-using-a-route-speed-model.html#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sp[i]<span class="sc">&gt;</span>sp[i<span class="sc">+</span><span class="dv">1</span>]) sp[i] <span class="ot">=</span> (dec <span class="sc">*</span> sp[i] <span class="sc">+</span> sp[i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>dec)</span>
<span id="cb82-18"><a href="interpolation-using-a-route-speed-model.html#cb82-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-19"><a href="interpolation-using-a-route-speed-model.html#cb82-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-20"><a href="interpolation-using-a-route-speed-model.html#cb82-20" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>acc_sp <span class="ot">=</span> sp</span>
<span id="cb82-21"><a href="interpolation-using-a-route-speed-model.html#cb82-21" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>acc_sp[<span class="fu">length</span>(sp)] <span class="ot">=</span> route_convexity<span class="sc">$</span>invisible_sp[<span class="fu">length</span>(sp)]</span>
<span id="cb82-22"><a href="interpolation-using-a-route-speed-model.html#cb82-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-23"><a href="interpolation-using-a-route-speed-model.html#cb82-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># New time model</span></span>
<span id="cb82-24"><a href="interpolation-using-a-route-speed-model.html#cb82-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also get speed in m/s for time calculation</span></span>
<span id="cb82-25"><a href="interpolation-using-a-route-speed-model.html#cb82-25" aria-hidden="true" tabindex="-1"></a>  meters <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb82-26"><a href="interpolation-using-a-route-speed-model.html#cb82-26" aria-hidden="true" tabindex="-1"></a>  seconds_per_hour <span class="ot">=</span> <span class="dv">3600</span> <span class="co"># 60 * 60</span></span>
<span id="cb82-27"><a href="interpolation-using-a-route-speed-model.html#cb82-27" aria-hidden="true" tabindex="-1"></a>  kph_unit <span class="ot">=</span> meters <span class="sc">/</span> seconds_per_hour</span>
<span id="cb82-28"><a href="interpolation-using-a-route-speed-model.html#cb82-28" aria-hidden="true" tabindex="-1"></a>  route_convexity <span class="ot">=</span> route_convexity <span class="sc">%&gt;%</span> </span>
<span id="cb82-29"><a href="interpolation-using-a-route-speed-model.html#cb82-29" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">segment_sp =</span> route_convexity<span class="sc">$</span>acc_sp <span class="sc">*</span> kph_unit,</span>
<span id="cb82-30"><a href="interpolation-using-a-route-speed-model.html#cb82-30" aria-hidden="true" tabindex="-1"></a>                             <span class="at">invisible_time =</span> dist<span class="sc">/</span>segment_sp,</span>
<span id="cb82-31"><a href="interpolation-using-a-route-speed-model.html#cb82-31" aria-hidden="true" tabindex="-1"></a>                             <span class="at">acc_time =</span> <span class="fu">cumsum</span>(invisible_time))</span>
<span id="cb82-32"><a href="interpolation-using-a-route-speed-model.html#cb82-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-33"><a href="interpolation-using-a-route-speed-model.html#cb82-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-34"><a href="interpolation-using-a-route-speed-model.html#cb82-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So now we need to generate kilometer marks</span></span>
<span id="cb82-35"><a href="interpolation-using-a-route-speed-model.html#cb82-35" aria-hidden="true" tabindex="-1"></a>  route_convexity<span class="sc">$</span>kmsection <span class="ot">=</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">trunc</span>(route_convexity<span class="sc">$</span>MidMeas<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb82-36"><a href="interpolation-using-a-route-speed-model.html#cb82-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We can use this to help find the time over each km</span></span>
<span id="cb82-37"><a href="interpolation-using-a-route-speed-model.html#cb82-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-38"><a href="interpolation-using-a-route-speed-model.html#cb82-38" aria-hidden="true" tabindex="-1"></a>  route_convexity</span>
<span id="cb82-39"><a href="interpolation-using-a-route-speed-model.html#cb82-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If we now apply the acceleration model to the route, we can calculate the speed over each segment, and the time taken to complete the segment:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="interpolation-using-a-route-speed-model.html#cb83-1" aria-hidden="true" tabindex="-1"></a>route_convexity <span class="ot">=</span> <span class="fu">acceleration_model</span>(route_convexity)</span>
<span id="cb83-2"><a href="interpolation-using-a-route-speed-model.html#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="interpolation-using-a-route-speed-model.html#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(route_convexity, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   FID                   RID MidMeas WindowSize RawConvexity ConvexityIndex
## 1   1 SS7/11 KakaristoHassi      10         20        0.000          0.000
## 2   1 SS7/11 KakaristoHassi      20         20        0.000          0.000
## 3   1 SS7/11 KakaristoHassi      30         20        0.788          0.079
##   Sinuosity Midpoint_X Midpoint_Y dist cum_dist radius invisible_ci
## 1     0.500   400689.0    6857086   10       10    Inf           11
## 2     0.500   400698.6    6857084   10       20    Inf           11
## 3     0.503   400708.3    6857081   10       30    Inf           11
##   invisible_sp   acc_sp segment_sp invisible_time acc_time kmsection
## 1          170 30.00000   8.333333      1.2000000 1.200000         1
## 2          170 42.72727  11.868687      0.8425532 2.042553         1
## 3          170 54.29752  15.082645      0.6630137 2.705567         1</code></pre>
<p>Summing over the segment times (omitting the flying finish which has no specified ongoing segment length) gives us an estimated stage time</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="interpolation-using-a-route-speed-model.html#cb85-1" aria-hidden="true" tabindex="-1"></a>anticipated_time <span class="ot">=</span> <span class="cf">function</span>(route_convexity) {</span>
<span id="cb85-2"><a href="interpolation-using-a-route-speed-model.html#cb85-2" aria-hidden="true" tabindex="-1"></a>  anticipated_time <span class="ot">=</span> <span class="fu">sum</span>(route_convexity<span class="sc">$</span>invisible_time[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(route_convexity)<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb85-3"><a href="interpolation-using-a-route-speed-model.html#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">&quot;Anticipated stage time: &quot;</span>, anticipated_time <span class="sc">%/%</span> <span class="dv">60</span>,</span>
<span id="cb85-4"><a href="interpolation-using-a-route-speed-model.html#cb85-4" aria-hidden="true" tabindex="-1"></a>           <span class="st">&#39;m &#39;</span>, <span class="fu">round</span>(anticipated_time <span class="sc">%%</span> <span class="dv">60</span>, <span class="dv">1</span>), <span class="st">&#39;s&#39;</span> ))</span>
<span id="cb85-5"><a href="interpolation-using-a-route-speed-model.html#cb85-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-6"><a href="interpolation-using-a-route-speed-model.html#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="interpolation-using-a-route-speed-model.html#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="fu">anticipated_time</span>(route_convexity)</span></code></pre></div>
<pre><code>## Anticipated stage time: 9m 11.2s</code></pre>
<p>We can also view the speed model over distance into stage:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="interpolation-using-a-route-speed-model.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(route_convexity) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>cum_dist, <span class="at">y=</span>acc_sp))</span></code></pre></div>
<p><img src="images/unnamed-chunk-39-1.png" width="672" /></p>
<p>We can also plot the time model into the stage as the accumulated time:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="interpolation-using-a-route-speed-model.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(route_convexity) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>cum_dist, <span class="at">y=</span>acc_time))</span></code></pre></div>
<p><img src="images/unnamed-chunk-40-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="estimating-time-deltas-between-drivers-over-small-sections.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="full-telemetry.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toc_depth": 3,
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

</body>

</html>
